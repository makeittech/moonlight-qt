name: Test Steam Deck Build

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main

jobs:
  test-build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Flatpak environment
      run: |
        echo "Setting up Flatpak environment..."
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder
        
        # Add Flathub repository
        flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
        
        # Install required runtimes
        flatpak install --user org.kde.Platform//6.5 org.kde.Sdk//6.5 -y || true
        
        echo "Flatpak setup complete"
    
    - name: Build test Flatpak
      run: |
        echo "Building test Flatpak package..."
        
        # Create build directory
        mkdir -p build-test
        
        # Build the Flatpak
        flatpak-builder \
          --force-clean \
          --user \
          --install-deps-from=flathub \
          --repo=repo-test \
          build-test \
          moonlight-steamdeck.yml
        
        echo "Test build completed"
    
    - name: Create test bundle
      run: |
        echo "Creating test Flatpak bundle..."
        
        # Create bundle
        flatpak build-bundle repo-test moonlight-steamdeck-test.flatpak com.moonlight_stream.Moonlight
        
        echo "Test bundle created"
    
    - name: Test build completion
      run: |
        echo "✅ Build test completed successfully!"
        echo "📦 Flatpak bundle created: moonlight-steamdeck-test.flatpak"
        echo "🎮 Ready for Steam Deck installation"
        
        # Check file size
        if [ -f moonlight-steamdeck-test.flatpak ]; then
          size=$(du -h moonlight-steamdeck-test.flatpak | cut -f1)
          echo "📊 Bundle size: $size"
        else
          echo "❌ Bundle file not found!"
          exit 1
        fi
    
    - name: Upload test artifact
      uses: actions/upload-artifact@v4
      with:
        name: moonlight-steamdeck-test
        path: moonlight-steamdeck-test.flatpak
        retention-days: 7