name: Test Steam Deck Build

on:
  workflow_dispatch:
  push:
    branches:
      - master
      - main

jobs:
  test-build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Flatpak
      uses: flatpak/flatpak-github-actions/flatpak-builder@v6
      with:
        bundle: moonlight-steamdeck-test
        cache-key: flatpak-builder-test-${{ hashFiles('moonlight-steamdeck.yml') }}
        manifest-path: moonlight-steamdeck.yml
    
    - name: Test build completion
      run: |
        echo "✅ Build test completed successfully!"
        echo "📦 Flatpak bundle created: moonlight-steamdeck-test.flatpak"
        echo "🎮 Ready for Steam Deck installation"
        
        # Check file size
        if [ -f moonlight-steamdeck-test.flatpak ]; then
          size=$(du -h moonlight-steamdeck-test.flatpak | cut -f1)
          echo "📊 Bundle size: $size"
        else
          echo "❌ Bundle file not found!"
          exit 1
        fi
        
        # Validate bundle
        echo "🔍 Validating Flatpak bundle..."
        if flatpak build-bundle --list-contents moonlight-steamdeck-test.flatpak > /dev/null 2>&1; then
          echo "✅ Bundle validation passed"
        else
          echo "❌ Bundle validation failed"
          exit 1
        fi
    
    - name: Upload test artifact
      uses: actions/upload-artifact@v4
      with:
        name: moonlight-steamdeck-test
        path: moonlight-steamdeck-test.flatpak
        retention-days: 7